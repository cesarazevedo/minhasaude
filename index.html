<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dashboard de sa√∫de com exames laboratoriais - C√©sar Augusto de Freitas Azevedo">
    <meta name="author" content="C√©sar Augusto de Freitas Azevedo">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ù§Ô∏è</text></svg>">
    <title>MinhaSa√∫de - Dashboard de Exames</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #38ef7d;
            --success-dark: #22c55e;
            --warning: #f7971e;
            --danger: #ff758c;
            --danger-dark: #ef4444;
            --bg-light: #f4f7fe;
            --text-dark: #2d3748;
            --table-header: #009879;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        .top-header {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 10;
        }
        .brand {
            font-size: 1.5em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .brand-text {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .patient-info-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .patient-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2em;
        }
        .patient-details h3 {
            font-size: 1.1em;
            color: var(--text-dark);
        }
        .patient-details p {
            font-size: 0.85em;
            color: #718096;
        }

        /* MAIN */
        .main-container {
            flex: 1;
            padding: 30px;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
        }

        /* TABS */
        .tabs-nav {
            display: flex;
            gap: 6px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 2px;
            flex-wrap: wrap;
            align-items: center;
        }
        .tab-btn {
            padding: 10px 18px;
            background: transparent;
            border: none;
            font-size: 0.9em;
            font-weight: 600;
            color: #718096;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            border-radius: 8px 8px 0 0;
            white-space: nowrap;
        }
        .tab-btn:hover {
            color: var(--primary);
            background: rgba(102, 126, 234, 0.05);
        }
        .tab-btn.active {
            color: var(--primary);
            background: white;
        }
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--primary);
            border-radius: 4px 4px 0 0;
        }
        .tab-separator {
            width: 2px;
            height: 24px;
            background: #cbd5e0;
            margin: 0 6px;
            flex-shrink: 0;
        }

        /* CONTENT AREA */
        .tab-content {
            animation: fadeIn 0.4s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ====== DASHBOARD ====== */
        .alerts-section {
            margin-bottom: 28px;
        }
        .alerts-section h3 {
            font-size: 1.05em;
            color: #4a5568;
            margin-bottom: 12px;
        }
        .alert-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 0.92em;
            font-weight: 500;
        }
        .alert-danger {
            background: #fff5f5;
            border-left: 4px solid var(--danger-dark);
            color: #9b2c2c;
        }
        .alert-warning {
            background: #fffbeb;
            border-left: 4px solid var(--warning);
            color: #92400e;
        }
        .alert-icon { font-size: 1.2em; }
        .alert-name { font-weight: 700; }
        .alert-detail { opacity: 0.8; font-size: 0.9em; }

        .category-section {
            margin-bottom: 32px;
        }
        .category-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #4a5568;
            margin-bottom: 14px;
            padding-bottom: 6px;
            border-bottom: 2px solid #e2e8f0;
        }
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }
        .exam-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid var(--primary);
            position: relative;
        }
        .exam-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .exam-card.status-normal { border-left-color: var(--success-dark); }
        .exam-card.status-warning { border-left-color: var(--warning); }
        .exam-card.status-danger { border-left-color: var(--danger-dark); }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .card-name {
            font-size: 0.85em;
            color: #718096;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .card-badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 999px;
            font-size: 0.72em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .badge-normal { background: #f0fff4; color: #276749; }
        .badge-warning { background: #fffbeb; color: #92400e; }
        .badge-danger { background: #fff5f5; color: #9b2c2c; }

        .card-value {
            font-size: 1.8em;
            font-weight: 800;
            color: var(--text-dark);
            margin-bottom: 4px;
            line-height: 1.1;
        }
        .card-unit {
            font-size: 0.45em;
            font-weight: 500;
            color: #a0aec0;
            margin-left: 2px;
        }
        .card-ref {
            font-size: 0.78em;
            color: #a0aec0;
        }

        /* ====== EVOLU√á√ÉO ====== */
        .evolution-section {
            margin-bottom: 36px;
        }
        .evolution-section h3 {
            font-size: 1.1em;
            font-weight: 700;
            color: #4a5568;
            margin-bottom: 14px;
        }
        .evo-table-wrap {
            background: white;
            border-radius: 16px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            overflow-x: auto;
            margin-bottom: 36px;
        }
        .evo-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.88em;
            min-width: 700px;
        }
        .evo-table thead tr {
            background: var(--table-header);
            color: white;
        }
        .evo-table th {
            padding: 12px 14px;
            font-weight: 600;
            white-space: nowrap;
            text-align: center;
        }
        .evo-table th:first-child { text-align: left; }
        .evo-table td {
            padding: 10px 14px;
            border-bottom: 1px solid #f0f0f0;
            text-align: center;
            white-space: nowrap;
        }
        .evo-table td:first-child {
            text-align: left;
            font-weight: 600;
            color: #4a5568;
        }
        .evo-table tbody tr:hover { background: #f6f8ff; }
        .evo-table tbody tr:last-child td { border-bottom: none; }
        .val-up { color: var(--danger-dark); }
        .val-down { color: var(--success-dark); }
        .val-same { color: #718096; }
        .arrow { font-size: 0.85em; margin-left: 2px; }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
            gap: 24px;
        }
        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .chart-card h4 {
            font-size: 0.95em;
            color: #4a5568;
            margin-bottom: 12px;
        }

        /* TABLE (CSV tabs) */
        .table-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.92em;
        }
        .data-table thead tr {
            background-color: var(--table-header);
            color: #ffffff;
            text-align: left;
        }
        .data-table th {
            padding: 14px 16px;
            font-weight: 600;
            white-space: nowrap;
        }
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        .data-table tbody tr {
            transition: background-color 0.2s;
        }
        .data-table tbody tr:hover {
            background-color: #f6f8ff;
        }
        .data-table tbody tr:last-of-type td {
            border-bottom: none;
        }

        /* LOADING */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            gap: 16px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text {
            color: #718096;
            font-size: 0.95em;
        }

        /* ERROR */
        .error-container {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
        }
        .error-container .error-icon {
            font-size: 2.5em;
            margin-bottom: 12px;
        }
        .error-container button {
            margin-top: 16px;
            padding: 10px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        .error-container button:hover { opacity: 0.85; }

        /* FOOTER */
        .footer {
            text-align: center;
            padding: 20px;
            color: #a0aec0;
            font-size: 0.85em;
            border-top: 1px solid #e2e8f0;
            margin-top: 40px;
        }
        .footer a {
            color: var(--primary);
            text-decoration: none;
        }

        /* DATA SOURCE */
        .data-source {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.85em;
            margin-bottom: 20px;
        }
        .data-source-online {
            background: #f0fff4;
            color: #276749;
        }
        .data-source-offline {
            background: #fff5f5;
            color: #9b2c2c;
        }
        .source-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .source-online { background: #38a169; }
        .source-offline { background: #e53e3e; }
        .source-time { opacity: 0.7; }
        .btn-refresh {
            margin-left: auto;
            padding: 4px 12px;
            background: transparent;
            border: 1px solid currentColor;
            border-radius: 6px;
            color: inherit;
            cursor: pointer;
            font-size: 0.9em;
            transition: opacity 0.2s;
        }
        .btn-refresh:hover { opacity: 0.7; }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .top-header {
                flex-direction: column;
                gap: 10px;
                padding: 12px 16px;
            }
            .main-container { padding: 16px; }
            .tabs-nav { gap: 4px; }
            .tab-btn {
                padding: 8px 12px;
                font-size: 0.8em;
            }
            .data-table { font-size: 0.82em; }
            .data-table th, .data-table td {
                padding: 8px 10px;
            }
            .table-card { overflow-x: auto; }
            .cards-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 10px;
            }
            .exam-card { padding: 14px; }
            .card-value { font-size: 1.4em; }
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .chart-card { padding: 14px; }
            .tab-separator { display: none; }
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="top-header">
        <div class="brand">
            <span class="brand-text">MinhaSaude</span>
        </div>
        <div class="patient-info-header">
            <div class="patient-avatar">CA</div>
            <div class="patient-details">
                <h3>Cesar Augusto de Freitas Azevedo</h3>
                <p>Dashboard de Exames</p>
            </div>
        </div>
    </header>

    <!-- MAIN -->
    <main class="main-container">
        <div id="dataSource" class="data-source" style="display:none;"></div>
        <nav id="tabsNav" class="tabs-nav"></nav>
        <section id="tabContent"></section>
    </main>

    <!-- FOOTER -->
    <footer class="footer">
        Dados carregados automaticamente do Google Sheets.
        Adicione novos exames na planilha e recarregue a pagina.
    </footer>

<script>
// ===== CONFIG =====
const SPREADSHEET_PUB_ID = '2PACX-1vT0LSmB9V0Xw-QvcPUsIenXz8FVTEpfuP4CtX2nBlYitPcNHUUs1YgsXwUU4Cadb67Iv_biFuxdl9Rn';

const SHEETS = [
    { name: 'Hemograma 31/01/2026', gid: '912209641' },
    { name: 'Colesterol 31/01/2026', gid: '2010398228' },
    { name: 'Demais 31/01/2026', gid: '318227406' },
    { name: 'Lipoproteina A 03/02/2026', gid: '1247256957' },
    { name: 'PSA 11/11/2023', gid: '937090680' },
    { name: 'Checkup 09/10/2023', gid: '559948215' },
    { name: 'Checkup 09/05/2023', gid: '1269112884' },
    { name: 'Gastro 04/07/2022', gid: '740994487' },
    { name: 'Covid 26/09/2022', gid: '226297418' },
    { name: 'Checkup 18/12/2021', gid: '1918559974' },
    { name: 'Checkup 06/10/2021', gid: '1324492065' },
    { name: 'Checkup 19/03/2021', gid: '1048005645' },
    { name: 'Covid 15/03/2021', gid: '237661920' },
];

const csvCache = {};
let activeTab = 'dashboard'; // 'dashboard', 'evolucao', or sheet index

// ===== DASHBOARD DATA =====
const DASHBOARD_DATA = {
    alerts: [
        { icon: 'üî¥', name: 'HDL', value: '30 mg/dL', ref: 'ref: >40', detail: 'Abaixo do desej√°vel', type: 'danger' },
        { icon: '‚ö†Ô∏è', name: 'Glicose', value: '101 mg/dL', ref: 'ref: 70-99', detail: 'Alterada', type: 'warning' },
        { icon: '‚ö†Ô∏è', name: 'Lipoprote√≠na A', value: '47.8 mg/dL', ref: 'ref: <30', detail: 'Elevada', type: 'warning' },
        { icon: '‚ö†Ô∏è', name: 'Vitamina A', value: '0.84 mg/L', ref: 'ref: 0.30-0.70', detail: 'Acima', type: 'warning' },
    ],
    categories: [
        {
            title: 'Metabolismo',
            exams: [
                { name: 'Glicose', value: 101, unit: 'mg/dL', ref: '70 - 99', status: 'warning' },
                { name: 'HbA1c', value: 5.0, unit: '%', ref: '< 5.7', status: 'normal' },
                { name: '√Åcido √örico', value: 5.4, unit: 'mg/dL', ref: '3.5 - 7.2', status: 'normal' },
            ]
        },
        {
            title: 'Lip√≠dios',
            exams: [
                { name: 'Colesterol Total', value: 148, unit: 'mg/dL', ref: '< 190', status: 'normal' },
                { name: 'HDL', value: 30, unit: 'mg/dL', ref: '> 40', status: 'danger' },
                { name: 'LDL', value: 96.8, unit: 'mg/dL', ref: '< 130', status: 'normal' },
                { name: 'VLDL', value: 21.2, unit: 'mg/dL', ref: '< 30', status: 'normal' },
                { name: 'Triglicer√≠deos', value: 106, unit: 'mg/dL', ref: '< 150', status: 'normal' },
                { name: 'Lipoprote√≠na A', value: 47.8, unit: 'mg/dL', ref: '< 30', status: 'warning' },
            ]
        },
        {
            title: 'Renal / Hep√°tica',
            exams: [
                { name: 'Creatinina', value: 1.00, unit: 'mg/dL', ref: '0.7 - 1.3', status: 'normal' },
                { name: 'Ureia', value: 35, unit: 'mg/dL', ref: '15 - 40', status: 'normal' },
                { name: 'TGO (AST)', value: 25, unit: 'U/L', ref: '< 40', status: 'normal' },
                { name: 'TGP (ALT)', value: 36, unit: 'U/L', ref: '< 41', status: 'normal' },
                { name: 'GGT', value: 32, unit: 'U/L', ref: '< 60', status: 'normal' },
                { name: 'Fosfatase Alcalina', value: 47, unit: 'U/L', ref: '40 - 129', status: 'normal' },
                { name: 'Bilirrubina Total', value: 0.98, unit: 'mg/dL', ref: '< 1.2', status: 'normal' },
            ]
        },
        {
            title: 'Horm√¥nios',
            exams: [
                { name: 'TSH', value: 1.82, unit: 'mUI/L', ref: '0.27 - 4.20', status: 'normal' },
                { name: 'T4 Livre', value: 1.02, unit: 'ng/dL', ref: '0.93 - 1.70', status: 'normal' },
                { name: 'Testosterona Total', value: 319, unit: 'ng/dL', ref: '249 - 836', status: 'normal' },
                { name: 'Testosterona Livre', value: 8.95, unit: 'pg/mL', ref: '4.5 - 42', status: 'normal' },
                { name: 'PSA Total', value: 0.46, unit: 'ng/mL', ref: '< 4.0', status: 'normal' },
            ]
        },
        {
            title: 'Vitaminas / Minerais',
            exams: [
                { name: 'Vitamina D', value: 37.6, unit: 'ng/mL', ref: '30 - 60', status: 'normal' },
                { name: 'Vitamina B12', value: 192, unit: 'pg/mL', ref: '187 - 883', status: 'normal' },
                { name: 'Vitamina A', value: 0.84, unit: 'mg/L', ref: '0.30 - 0.70', status: 'warning' },
                { name: 'Ferritina', value: 139.5, unit: 'ng/mL', ref: '30 - 400', status: 'normal' },
            ]
        },
        {
            title: 'Hemograma',
            exams: [
                { name: 'Hemoglobina', value: 15.6, unit: 'g/dL', ref: '13.0 - 17.5', status: 'normal' },
                { name: 'Hemat√≥crito', value: 44.7, unit: '%', ref: '39 - 50', status: 'normal' },
                { name: 'Leuc√≥citos', value: 5630, unit: '/mm¬≥', ref: '3500 - 10500', status: 'normal' },
                { name: 'Plaquetas', value: 183000, unit: '/mm¬≥', ref: '150.000 - 400.000', status: 'normal' },
            ]
        },
    ]
};

// ===== EVOLU√á√ÉO DATA =====
const EVO_DATES = ['19/03/2021', '06/10/2021', '04/07/2022', '09/10/2023', '31/01/2026'];

// null = not measured on that date
const EVO_EXAMS = [
    { name: 'Glicose', unit: 'mg/dL', ref: '70-99', refMin: 70, refMax: 99, values: [92, 93, 94, 97, 101], higher_is_worse: true },
    { name: 'HbA1c', unit: '%', ref: '<5.7', refMin: null, refMax: 5.7, values: [null, 5.4, null, 5.2, 5.0], higher_is_worse: true },
    { name: 'Colesterol Total', unit: 'mg/dL', ref: '<190', refMin: null, refMax: 190, values: [185, 193, 180, 169, 148], higher_is_worse: true },
    { name: 'HDL', unit: 'mg/dL', ref: '>40', refMin: 40, refMax: null, values: [39, 47, 38, 38, 30], higher_is_worse: false },
    { name: 'Triglicer√≠deos', unit: 'mg/dL', ref: '<150', refMin: null, refMax: 150, values: [116, 123, 92, 104, 106], higher_is_worse: true },
    { name: 'Creatinina', unit: 'mg/dL', ref: '0.7-1.3', refMin: 0.7, refMax: 1.3, values: [0.93, 1.06, 0.99, 1.06, 1.00], higher_is_worse: true },
    { name: '√Åcido √örico', unit: 'mg/dL', ref: '3.5-7.2', refMin: 3.5, refMax: 7.2, values: [5.3, 6.1, 5.2, 5.4, 5.4], higher_is_worse: true },
    { name: 'TGO (AST)', unit: 'U/L', ref: '<40', refMin: null, refMax: 40, values: [24, 19, 27, 26, 25], higher_is_worse: true },
    { name: 'TGP (ALT)', unit: 'U/L', ref: '<41', refMin: null, refMax: 41, values: [35, 24, 35, 41, 36], higher_is_worse: true },
    { name: 'GGT', unit: 'U/L', ref: '<60', refMin: null, refMax: 60, values: [37, 32, 35, 39, 32], higher_is_worse: true },
    { name: 'TSH', unit: 'mUI/L', ref: '0.27-4.20', refMin: 0.27, refMax: 4.20, values: [1.70, 2.15, null, 2.32, 1.82], higher_is_worse: null },
    { name: 'Vitamina D', unit: 'ng/mL', ref: '30-60', refMin: 30, refMax: 60, values: [20.4, 50.2, null, 43.5, 37.6], higher_is_worse: false },
    { name: 'B12', unit: 'pg/mL', ref: '187-883', refMin: 187, refMax: 883, values: [null, 300, null, 276, 192], higher_is_worse: false },
    { name: 'Hemoglobina', unit: 'g/dL', ref: '13-17.5', refMin: 13, refMax: 17.5, values: [15.5, 15.8, 16.0, 15.8, 15.6], higher_is_worse: null },
    { name: 'Leuc√≥citos', unit: '/mm¬≥', ref: '3500-10500', refMin: 3500, refMax: 10500, values: [5850, 6290, 7150, 6280, 5630], higher_is_worse: null },
    { name: 'Plaquetas', unit: '/mm¬≥', ref: '150k-400k', refMin: 150000, refMax: 400000, values: [186000, 195000, 197000, 189000, 183000], higher_is_worse: null },
    { name: 'PSA Total', unit: 'ng/mL', ref: '<4.0', refMin: null, refMax: 4.0, values: [null, null, null, 0.46, 0.46], higher_is_worse: true },
];

// Chart groupings
const CHART_GROUPS = [
    { title: 'Glicose & HbA1c', exams: ['Glicose', 'HbA1c'] },
    { title: 'Colesterol / HDL / Triglicer√≠deos', exams: ['Colesterol Total', 'HDL', 'Triglicer√≠deos'] },
    { title: 'Creatinina', exams: ['Creatinina'] },
    { title: 'TGO / TGP / GGT', exams: ['TGO (AST)', 'TGP (ALT)', 'GGT'] },
    { title: 'PSA Total', exams: ['PSA Total'] },
    { title: 'Vitamina D & B12', exams: ['Vitamina D', 'B12'] },
];

const CHART_COLORS = ['#667eea', '#f7971e', '#38ef7d', '#ff758c', '#764ba2', '#00b4d8'];
let chartInstances = [];

// ===== CSV URL =====
function csvUrl(gid) {
    return `https://docs.google.com/spreadsheets/d/e/${SPREADSHEET_PUB_ID}/pub?output=csv&gid=${gid}`;
}

// ===== CSV PARSER =====
function parseCSV(text) {
    const rows = [];
    let current = '';
    let inQuotes = false;
    let row = [];

    for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (inQuotes) {
            if (ch === '"' && text[i + 1] === '"') {
                current += '"';
                i++;
            } else if (ch === '"') {
                inQuotes = false;
            } else {
                current += ch;
            }
        } else {
            if (ch === '"') {
                inQuotes = true;
            } else if (ch === ',') {
                row.push(current.trim());
                current = '';
            } else if (ch === '\n' || (ch === '\r' && text[i + 1] === '\n')) {
                row.push(current.trim());
                current = '';
                if (ch === '\r') i++;
                if (row.some(cell => cell !== '')) rows.push(row);
                row = [];
            } else {
                current += ch;
            }
        }
    }
    if (current || row.length > 0) {
        row.push(current.trim());
        if (row.some(cell => cell !== '')) rows.push(row);
    }
    return rows;
}

// ===== RENDER TABS =====
function renderTabs() {
    const nav = document.getElementById('tabsNav');
    let html = '';
    html += `<button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>`;
    html += `<button class="tab-btn" onclick="switchTab('evolucao')">Evolu√ß√£o</button>`;
    html += `<div class="tab-separator"></div>`;
    SHEETS.forEach((sheet, i) => {
        html += `<button class="tab-btn" data-sheet="${i}" onclick="switchTab(${i})">${sheet.name}</button>`;
    });
    nav.innerHTML = html;
}

// ===== SWITCH TAB =====
async function switchTab(tab) {
    // Destroy old charts
    chartInstances.forEach(c => c.destroy());
    chartInstances = [];

    // Update active button
    document.querySelectorAll('.tab-btn').forEach(btn => {
        let isActive = false;
        if (tab === 'dashboard' && btn.textContent === 'Dashboard') isActive = true;
        else if (tab === 'evolucao' && btn.textContent === 'Evolu√ß√£o') isActive = true;
        else if (typeof tab === 'number' && btn.dataset.sheet == tab) isActive = true;
        btn.classList.toggle('active', isActive);
    });

    activeTab = tab;
    const content = document.getElementById('tabContent');

    if (tab === 'dashboard') {
        renderDashboard();
        return;
    }
    if (tab === 'evolucao') {
        renderEvolucao();
        return;
    }

    // CSV sheet tab
    const index = tab;
    const sheet = SHEETS[index];

    if (csvCache[sheet.gid]) {
        renderTable(csvCache[sheet.gid], sheet.name);
        return;
    }

    content.innerHTML = `
        <div class="table-card">
            <div class="loading-container">
                <div class="spinner"></div>
                <div class="loading-text">Carregando ${sheet.name}...</div>
            </div>
        </div>`;

    try {
        const resp = await fetch(csvUrl(sheet.gid));
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const text = await resp.text();
        const rows = parseCSV(text);
        csvCache[sheet.gid] = rows;
        if (activeTab === index) {
            renderTable(rows, sheet.name);
        }
        showDataSource(true);
    } catch (err) {
        console.warn('Erro ao carregar:', err);
        if (activeTab === index) {
            content.innerHTML = `
                <div class="table-card">
                    <div class="error-container">
                        <div class="error-icon">&#9888;</div>
                        <p>Nao foi possivel carregar os dados de <strong>${sheet.name}</strong>.</p>
                        <p style="font-size:0.85em;margin-top:8px;">${err.message}</p>
                        <button onclick="switchTab(${index})">Tentar novamente</button>
                    </div>
                </div>`;
        }
        showDataSource(false);
    }
}

// ===== RENDER DASHBOARD =====
function renderDashboard() {
    const content = document.getElementById('tabContent');
    let html = '<div class="tab-content">';

    // Alerts
    html += '<div class="alerts-section"><h3>Alertas ‚Äî Exames fora da faixa</h3>';
    DASHBOARD_DATA.alerts.forEach(a => {
        html += `<div class="alert-item alert-${a.type}">
            <span class="alert-icon">${a.icon}</span>
            <span class="alert-name">${a.name}:</span>
            <span>${a.value}</span>
            <span class="alert-detail">(${a.ref}) ‚Äî ${a.detail}</span>
        </div>`;
    });
    html += '</div>';

    // Categories
    DASHBOARD_DATA.categories.forEach(cat => {
        html += `<div class="category-section">
            <div class="category-title">${cat.title}</div>
            <div class="cards-grid">`;
        cat.exams.forEach(ex => {
            const badgeClass = ex.status === 'normal' ? 'badge-normal' : ex.status === 'warning' ? 'badge-warning' : 'badge-danger';
            const badgeText = ex.status === 'normal' ? 'Normal' : ex.status === 'warning' ? 'Alerta' : 'Cr√≠tico';
            const displayValue = ex.name === 'Plaquetas' ? (ex.value / 1000).toFixed(0) + '.000' : ex.value;
            html += `<div class="exam-card status-${ex.status}">
                <div class="card-header">
                    <span class="card-name">${ex.name}</span>
                    <span class="card-badge ${badgeClass}">${badgeText}</span>
                </div>
                <div class="card-value">${displayValue}<span class="card-unit">${ex.unit}</span></div>
                <div class="card-ref">Ref: ${ex.ref}</div>
            </div>`;
        });
        html += '</div></div>';
    });

    html += '</div>';
    content.innerHTML = html;
}

// ===== RENDER EVOLU√á√ÉO =====
function renderEvolucao() {
    const content = document.getElementById('tabContent');
    let html = '<div class="tab-content">';

    // Comparative table
    html += '<div class="evolution-section"><h3>Tabela Comparativa</h3>';
    html += '<div class="evo-table-wrap"><table class="evo-table"><thead><tr>';
    html += '<th>Exame</th>';
    EVO_DATES.forEach(d => { html += `<th>${d}</th>`; });
    html += '</tr></thead><tbody>';

    EVO_EXAMS.forEach(exam => {
        html += '<tr>';
        html += `<td>${exam.name} <span style="color:#a0aec0;font-weight:400;font-size:0.85em">(${exam.unit})</span></td>`;
        exam.values.forEach((val, i) => {
            if (val === null) {
                html += '<td style="color:#cbd5e0">‚Äî</td>';
            } else {
                let arrow = '';
                let cls = '';
                if (i > 0) {
                    // Find previous non-null value
                    let prev = null;
                    for (let j = i - 1; j >= 0; j--) {
                        if (exam.values[j] !== null) { prev = exam.values[j]; break; }
                    }
                    if (prev !== null && val !== prev) {
                        const went_up = val > prev;
                        if (exam.higher_is_worse === true) {
                            cls = went_up ? 'val-up' : 'val-down';
                            arrow = went_up ? ' <span class="arrow">‚Üë</span>' : ' <span class="arrow">‚Üì</span>';
                        } else if (exam.higher_is_worse === false) {
                            cls = went_up ? 'val-down' : 'val-up';
                            arrow = went_up ? ' <span class="arrow">‚Üë</span>' : ' <span class="arrow">‚Üì</span>';
                        } else {
                            cls = 'val-same';
                            arrow = went_up ? ' <span class="arrow">‚Üë</span>' : ' <span class="arrow">‚Üì</span>';
                        }
                    }
                }
                const displayVal = exam.name === 'Plaquetas' || exam.name === 'Leuc√≥citos'
                    ? val.toLocaleString('pt-BR')
                    : val;
                html += `<td class="${cls}">${displayVal}${arrow}</td>`;
            }
        });
        html += '</tr>';
    });

    html += '</tbody></table></div></div>';

    // Charts
    html += '<div class="evolution-section"><h3>Gr√°ficos de Evolu√ß√£o</h3>';
    html += '<div class="charts-grid">';
    CHART_GROUPS.forEach((group, gi) => {
        html += `<div class="chart-card"><h4>${group.title}</h4><canvas id="chart-${gi}"></canvas></div>`;
    });
    html += '</div></div>';

    html += '</div>';
    content.innerHTML = html;

    // Render charts after DOM update
    requestAnimationFrame(() => renderCharts());
}

function renderCharts() {
    const dateLabels = EVO_DATES;

    CHART_GROUPS.forEach((group, gi) => {
        const canvas = document.getElementById(`chart-${gi}`);
        if (!canvas) return;

        const datasets = [];
        let refMin = null, refMax = null;

        group.exams.forEach((examName, ei) => {
            const exam = EVO_EXAMS.find(e => e.name === examName);
            if (!exam) return;

            if (ei === 0) {
                refMin = exam.refMin;
                refMax = exam.refMax;
            }

            datasets.push({
                label: exam.name,
                data: exam.values.map(v => v === null ? undefined : v),
                borderColor: CHART_COLORS[ei % CHART_COLORS.length],
                backgroundColor: CHART_COLORS[ei % CHART_COLORS.length] + '20',
                borderWidth: 2.5,
                pointRadius: 4,
                pointHoverRadius: 6,
                tension: 0.3,
                spanGaps: true,
            });
        });

        // Reference band as annotation via plugin
        const refBandPlugin = {
            id: 'refBand',
            beforeDraw(chart) {
                if (refMin === null && refMax === null) return;
                const { ctx, chartArea: { top, bottom, left, right }, scales: { y } } = chart;
                ctx.save();
                ctx.fillStyle = 'rgba(0,0,0,0.04)';
                const yTop = refMax !== null ? y.getPixelForValue(refMax) : top;
                const yBottom = refMin !== null ? y.getPixelForValue(refMin) : bottom;
                ctx.fillRect(left, Math.min(yTop, yBottom), right - left, Math.abs(yBottom - yTop));
                ctx.restore();
            }
        };

        const chart = new Chart(canvas, {
            type: 'line',
            data: { labels: dateLabels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: group.exams.length > 1, position: 'top', labels: { usePointStyle: true, boxWidth: 8 } },
                    tooltip: {
                        backgroundColor: 'white',
                        titleColor: '#2d3748',
                        bodyColor: '#4a5568',
                        borderColor: '#e2e8f0',
                        borderWidth: 1,
                        padding: 10,
                        cornerRadius: 8,
                    }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: {
                        beginAtZero: false,
                        grid: { color: '#f0f0f0' },
                    }
                }
            },
            plugins: [refBandPlugin]
        });
        chartInstances.push(chart);
    });
}

// ===== RENDER TABLE =====
function renderTable(rows, sheetName) {
    const content = document.getElementById('tabContent');

    if (!rows || rows.length === 0) {
        content.innerHTML = `
            <div class="table-card">
                <div class="empty-state">Nenhum dado encontrado em "${sheetName}".</div>
            </div>`;
        return;
    }

    const headers = rows[0];
    const dataRows = rows.slice(1);

    let html = '<div class="table-card"><table class="data-table"><thead><tr>';
    headers.forEach(h => {
        html += `<th>${escapeHTML(h)}</th>`;
    });
    html += '</tr></thead><tbody>';

    dataRows.forEach(row => {
        html += '<tr>';
        for (let i = 0; i < headers.length; i++) {
            const cell = row[i] || '';
            html += `<td>${escapeHTML(cell)}</td>`;
        }
        html += '</tr>';
    });

    html += '</tbody></table></div>';
    content.innerHTML = html;
}

// ===== HELPERS =====
function escapeHTML(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function showDataSource(online) {
    const el = document.getElementById('dataSource');
    el.style.display = 'flex';
    const timeStr = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    if (online) {
        el.innerHTML = `<span class="source-dot source-online"></span> Dados carregados do Google Sheets <span class="source-time">as ${timeStr}</span> <button class="btn-refresh" onclick="location.reload()">&#8635; Atualizar</button>`;
        el.className = 'data-source data-source-online';
    } else {
        el.innerHTML = `<span class="source-dot source-offline"></span> Erro ao carregar dados <button class="btn-refresh" onclick="location.reload()">&#8635; Tentar novamente</button>`;
        el.className = 'data-source data-source-offline';
    }
}

// ===== INIT =====
renderTabs();
switchTab('dashboard');
</script>

</body>
</html>
