<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dashboard de saúde com exames laboratoriais - César Augusto de Freitas Azevedo">
    <meta name="author" content="César Audgusto de Freitas Azevedo">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>❤️</text></svg>">
    <title>MinhaSaúde - Dashboard de Exames</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #38ef7d;
            --success-dark: #22c55e;
            --warning: #f7971e;
            --danger: #ff758c;
            --danger-dark: #ef4444;
            --bg-light: #f4f7fe;
            --text-dark: #2d3748;
            --table-header: #009879;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        .top-header {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 10;
        }
        .brand {
            font-size: 1.5em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .brand-text {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .patient-info-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .patient-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2em;
        }
        .patient-details h3 {
            font-size: 1.1em;
            color: var(--text-dark);
        }
        .patient-details p {
            font-size: 0.85em;
            color: #718096;
        }

        /* MAIN */
        .main-container {
            flex: 1;
            padding: 30px;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
        }

        /* TABS */
        .tabs-nav {
            display: flex;
            gap: 6px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 2px;
            flex-wrap: wrap;
            align-items: center;
        }
        .tab-btn {
            padding: 10px 18px;
            background: transparent;
            border: none;
            font-size: 0.9em;
            font-weight: 600;
            color: #718096;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            border-radius: 8px 8px 0 0;
            white-space: nowrap;
        }
        .tab-btn:hover {
            color: var(--primary);
            background: rgba(102, 126, 234, 0.05);
        }
        .tab-btn.active {
            color: var(--primary);
            background: white;
        }
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--primary);
            border-radius: 4px 4px 0 0;
        }
        .tab-separator {
            width: 2px;
            height: 24px;
            background: #cbd5e0;
            margin: 0 6px;
            flex-shrink: 0;
        }

        /* CONTENT AREA */
        .tab-content {
            animation: fadeIn 0.4s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ====== DASHBOARD ====== */
        .alerts-section {
            margin-bottom: 28px;
        }
        .alerts-section h3 {
            font-size: 1.05em;
            color: #4a5568;
            margin-bottom: 12px;
        }
        .alert-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 0.92em;
            font-weight: 500;
        }
        .alert-danger {
            background: #fff5f5;
            border-left: 4px solid var(--danger-dark);
            color: #9b2c2c;
        }
        .alert-warning {
            background: #fffbeb;
            border-left: 4px solid var(--warning);
            color: #92400e;
        }
        .alert-icon { font-size: 1.2em; }
        .alert-name { font-weight: 700; }
        .alert-detail { opacity: 0.8; font-size: 0.9em; }

        .category-section {
            margin-bottom: 32px;
        }
        .category-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #4a5568;
            margin-bottom: 14px;
            padding-bottom: 6px;
            border-bottom: 2px solid #e2e8f0;
        }
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }
        .exam-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid var(--primary);
            position: relative;
        }
        .exam-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .exam-card.status-normal { border-left-color: var(--success-dark); }
        .exam-card.status-warning { border-left-color: var(--warning); }
        .exam-card.status-danger { border-left-color: var(--danger-dark); }
        .exam-card.status-info { border-left-color: var(--primary); }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .card-name {
            font-size: 0.85em;
            color: #718096;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .card-badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 999px;
            font-size: 0.72em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .badge-normal { background: #f0fff4; color: #276749; }
        .badge-warning { background: #fffbeb; color: #92400e; }
        .badge-danger { background: #fff5f5; color: #9b2c2c; }
        .badge-info { background: #ebf8ff; color: #2b6cb0; }

        .card-value {
            font-size: 1.8em;
            font-weight: 800;
            color: var(--text-dark);
            margin-bottom: 4px;
            line-height: 1.1;
        }
        .card-unit {
            font-size: 0.45em;
            font-weight: 500;
            color: #a0aec0;
            margin-left: 2px;
        }
        .card-ref {
            font-size: 0.78em;
            color: #a0aec0;
        }

        /* ====== EVOLUÇÃO ====== */
        .evolution-section {
            margin-bottom: 36px;
        }
        .evolution-section h3 {
            font-size: 1.1em;
            font-weight: 700;
            color: #4a5568;
            margin-bottom: 14px;
        }
        .evo-table-wrap {
            background: white;
            border-radius: 16px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            overflow-x: auto;
            margin-bottom: 36px;
        }
        .evo-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.88em;
            min-width: 700px;
        }
        .evo-table thead tr {
            background: var(--table-header);
            color: white;
        }
        .evo-table th {
            padding: 12px 14px;
            font-weight: 600;
            white-space: nowrap;
            text-align: center;
        }
        .evo-table th:first-child { text-align: left; }
        .evo-table td {
            padding: 10px 14px;
            border-bottom: 1px solid #f0f0f0;
            text-align: center;
            white-space: nowrap;
        }
        .evo-table td:first-child {
            text-align: left;
            font-weight: 600;
            color: #4a5568;
        }
        .evo-table tbody tr:hover { background: #f6f8ff; }
        .evo-table tbody tr:last-child td { border-bottom: none; }
        .val-up { color: var(--danger-dark); }
        .val-down { color: var(--success-dark); }
        .val-same { color: #718096; }
        .arrow { font-size: 0.85em; margin-left: 2px; }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
            gap: 24px;
        }
        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .chart-card h4 {
            font-size: 0.95em;
            color: #4a5568;
            margin-bottom: 12px;
        }

        /* ====== LAB REPORT (CSV TABS) ====== */
        .lab-header {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .lab-header-title {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--text-dark);
        }
        .lab-header-meta {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            font-size: 0.85em;
            color: #718096;
        }
        .lab-header-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .lab-raw-section {
            margin-top: 24px;
        }
        .lab-raw-toggle {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.88em;
            font-weight: 600;
            color: #718096;
            cursor: pointer;
            transition: all 0.2s;
        }
        .lab-raw-toggle:hover { color: var(--primary); border-color: var(--primary); }
        .lab-raw-content {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            max-height: 500px;
            overflow-y: auto;
        }
        .lab-raw-content.show { display: block; }
        .lab-raw-content pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.82em;
            color: #4a5568;
            line-height: 1.6;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        /* TABLE (fallback) */
        .table-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.92em;
        }
        .data-table thead tr {
            background-color: var(--table-header);
            color: #ffffff;
            text-align: left;
        }
        .data-table th {
            padding: 14px 16px;
            font-weight: 600;
            white-space: nowrap;
        }
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        .data-table tbody tr {
            transition: background-color 0.2s;
        }
        .data-table tbody tr:hover {
            background-color: #f6f8ff;
        }
        .data-table tbody tr:last-of-type td {
            border-bottom: none;
        }

        /* LOADING */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            gap: 16px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text {
            color: #718096;
            font-size: 0.95em;
        }

        /* ERROR */
        .error-container {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
        }
        .error-container .error-icon {
            font-size: 2.5em;
            margin-bottom: 12px;
        }
        .error-container button {
            margin-top: 16px;
            padding: 10px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        .error-container button:hover { opacity: 0.85; }

        /* FOOTER */
        .footer {
            text-align: center;
            padding: 20px;
            color: #a0aec0;
            font-size: 0.85em;
            border-top: 1px solid #e2e8f0;
            margin-top: 40px;
        }
        .footer a {
            color: var(--primary);
            text-decoration: none;
        }

        /* DATA SOURCE */
        .data-source {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.85em;
            margin-bottom: 20px;
        }
        .data-source-online { background: #f0fff4; color: #276749; }
        .data-source-offline { background: #fff5f5; color: #9b2c2c; }
        .source-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .source-online { background: #38a169; }
        .source-offline { background: #e53e3e; }
        .source-time { opacity: 0.7; }
        .btn-refresh {
            margin-left: auto;
            padding: 4px 12px;
            background: transparent;
            border: 1px solid currentColor;
            border-radius: 6px;
            color: inherit;
            cursor: pointer;
            font-size: 0.9em;
            transition: opacity 0.2s;
        }
        .btn-refresh:hover { opacity: 0.7; }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .top-header {
                flex-direction: column;
                gap: 10px;
                padding: 12px 16px;
            }
            .main-container { padding: 16px; }
            .tabs-nav { gap: 4px; }
            .tab-btn {
                padding: 8px 12px;
                font-size: 0.8em;
            }
            .data-table { font-size: 0.82em; }
            .data-table th, .data-table td {
                padding: 8px 10px;
            }
            .table-card { overflow-x: auto; }
            .cards-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 10px;
            }
            .exam-card { padding: 14px; }
            .card-value { font-size: 1.4em; }
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .chart-card { padding: 14px; }
            .tab-separator { display: none; }
            .lab-header { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="top-header">
        <div class="brand">
            <span class="brand-text">MinhaSaude</span>
        </div>
        <div class="patient-info-header">
            <div class="patient-avatar">CA</div>
            <div class="patient-details">
                <h3>Cesar Augusto de Freitas Azevedo</h3>
                <p>Dashboard de Exames</p>
            </div>
        </div>
    </header>

    <!-- MAIN -->
    <main class="main-container">
        <div id="dataSource" class="data-source" style="display:none;"></div>
        <nav id="tabsNav" class="tabs-nav"></nav>
        <section id="tabContent"></section>
    </main>

    <!-- FOOTER -->
    <footer class="footer">
        Dados carregados automaticamente do Google Sheets.
        Adicione novos exames na planilha e recarregue a pagina.
    </footer>

<script>
// ===== CONFIG =====
const SPREADSHEET_PUB_ID = '2PACX-1vT0LSmB9V0Xw-QvcPUsIenXz8FVTEpfuP4CtX2nBlYitPcNHUUs1YgsXwUU4Cadb67Iv_biFuxdl9Rn';

// SHEETS é descoberto dinamicamente do pubhtml (fallback hardcoded)
let SHEETS = [
    { name: 'Hemograma 31/01/2026', gid: '912209641' },
    { name: 'Colesterol 31/01/2026', gid: '2010398228' },
    { name: 'Demais 31/01/2026', gid: '318227406' },
    { name: 'Lipoproteina A 03/02/2026', gid: '1247256957' },
    { name: 'PSA 11/11/2023', gid: '937090680' },
    { name: 'Checkup 09/10/2023', gid: '559948215' },
    { name: 'Checkup 09/05/2023', gid: '1269112884' },
    { name: 'Gastro 04/07/2022', gid: '740994487' },
    { name: 'Covid 26/09/2022', gid: '226297418' },
    { name: 'Checkup 18/12/2021', gid: '1918559974' },
    { name: 'Checkup 06/10/2021', gid: '1324492065' },
    { name: 'Checkup 19/03/2021', gid: '1048005645' },
    { name: 'Covid 15/03/2021', gid: '237661920' },
];

async function discoverSheets() {
    try {
        const url = `https://docs.google.com/spreadsheets/d/e/${SPREADSHEET_PUB_ID}/pubhtml`;
        const resp = await fetch(url);
        if (!resp.ok) return;
        const html = await resp.text();
        // Parse items.push({name: "...", ..., gid: "..."}) from the JS
        const re = /items\.push\(\{name:\s*"([^"]+)"[^}]*gid:\s*"(\d+)"/g;
        const discovered = [];
        let m;
        while ((m = re.exec(html)) !== null) {
            // Unescape JS string (e.g., \/ -> /)
            const name = m[1].replace(/\\(.)/g, '$1');
            discovered.push({ name, gid: m[2] });
        }
        if (discovered.length > 0) {
            SHEETS = discovered;
        }
    } catch (e) {
        console.warn('Usando lista de abas hardcoded:', e);
    }
}

const csvCache = {};
let activeTab = 'dashboard';

// ===== DASHBOARD DATA =====
const DASHBOARD_DATA = {
    alerts: [
        { icon: '\u{1F534}', name: 'HDL', value: '30 mg/dL', ref: 'ref: >40', detail: 'Abaixo do desejável', type: 'danger' },
        { icon: '\u26A0\uFE0F', name: 'Glicose', value: '101 mg/dL', ref: 'ref: 70-99', detail: 'Alterada', type: 'warning' },
        { icon: '\u26A0\uFE0F', name: 'Lipoproteína A', value: '47.8 mg/dL', ref: 'ref: <30', detail: 'Elevada', type: 'warning' },
        { icon: '\u26A0\uFE0F', name: 'Vitamina A', value: '0.84 mg/L', ref: 'ref: 0.30-0.70', detail: 'Acima', type: 'warning' },
    ],
    categories: [
        {
            title: 'Metabolismo',
            exams: [
                { name: 'Glicose', value: 101, unit: 'mg/dL', ref: '70 - 99', status: 'warning' },
                { name: 'HbA1c', value: 5.0, unit: '%', ref: '< 5.7', status: 'normal' },
                { name: '\u00C1cido \u00DArico', value: 5.4, unit: 'mg/dL', ref: '3.5 - 7.2', status: 'normal' },
            ]
        },
        {
            title: 'Lip\u00EDdios',
            exams: [
                { name: 'Colesterol Total', value: 148, unit: 'mg/dL', ref: '< 190', status: 'normal' },
                { name: 'HDL', value: 30, unit: 'mg/dL', ref: '> 40', status: 'danger' },
                { name: 'LDL', value: 96.8, unit: 'mg/dL', ref: '< 130', status: 'normal' },
                { name: 'VLDL', value: 21.2, unit: 'mg/dL', ref: '< 30', status: 'normal' },
                { name: 'Triglicer\u00EDdeos', value: 106, unit: 'mg/dL', ref: '< 150', status: 'normal' },
                { name: 'Lipoprote\u00EDna A', value: 47.8, unit: 'mg/dL', ref: '< 30', status: 'warning' },
            ]
        },
        {
            title: 'Renal / Hep\u00E1tica',
            exams: [
                { name: 'Creatinina', value: 1.00, unit: 'mg/dL', ref: '0.7 - 1.3', status: 'normal' },
                { name: 'Ureia', value: 35, unit: 'mg/dL', ref: '15 - 40', status: 'normal' },
                { name: 'TGO (AST)', value: 25, unit: 'U/L', ref: '< 40', status: 'normal' },
                { name: 'TGP (ALT)', value: 36, unit: 'U/L', ref: '< 41', status: 'normal' },
                { name: 'GGT', value: 32, unit: 'U/L', ref: '< 60', status: 'normal' },
                { name: 'Fosfatase Alcalina', value: 47, unit: 'U/L', ref: '40 - 129', status: 'normal' },
                { name: 'Bilirrubina Total', value: 0.98, unit: 'mg/dL', ref: '< 1.2', status: 'normal' },
            ]
        },
        {
            title: 'Horm\u00F4nios',
            exams: [
                { name: 'TSH', value: 1.82, unit: 'mUI/L', ref: '0.27 - 4.20', status: 'normal' },
                { name: 'T4 Livre', value: 1.02, unit: 'ng/dL', ref: '0.93 - 1.70', status: 'normal' },
                { name: 'Testosterona Total', value: 319, unit: 'ng/dL', ref: '249 - 836', status: 'normal' },
                { name: 'Testosterona Livre', value: 8.95, unit: 'pg/mL', ref: '4.5 - 42', status: 'normal' },
                { name: 'PSA Total', value: 0.46, unit: 'ng/mL', ref: '< 4.0', status: 'normal' },
            ]
        },
        {
            title: 'Vitaminas / Minerais',
            exams: [
                { name: 'Vitamina D', value: 37.6, unit: 'ng/mL', ref: '30 - 60', status: 'normal' },
                { name: 'Vitamina B12', value: 192, unit: 'pg/mL', ref: '187 - 883', status: 'normal' },
                { name: 'Vitamina A', value: 0.84, unit: 'mg/L', ref: '0.30 - 0.70', status: 'warning' },
                { name: 'Ferritina', value: 139.5, unit: 'ng/mL', ref: '30 - 400', status: 'normal' },
            ]
        },
        {
            title: 'Hemograma',
            exams: [
                { name: 'Hemoglobina', value: 15.6, unit: 'g/dL', ref: '13.0 - 17.5', status: 'normal' },
                { name: 'Hemat\u00F3crito', value: 44.7, unit: '%', ref: '39 - 50', status: 'normal' },
                { name: 'Leuc\u00F3citos', value: 5630, unit: '/mm\u00B3', ref: '3500 - 10500', status: 'normal' },
                { name: 'Plaquetas', value: 183000, unit: '/mm\u00B3', ref: '150.000 - 400.000', status: 'normal' },
            ]
        },
    ]
};

// ===== EVOLUÇÃO DATA =====
const EVO_DATES = ['19/03/2021', '06/10/2021', '04/07/2022', '09/10/2023', '31/01/2026'];

const EVO_EXAMS = [
    { name: 'Glicose', unit: 'mg/dL', ref: '70-99', refMin: 70, refMax: 99, values: [92, 93, 94, 97, 101], higher_is_worse: true },
    { name: 'HbA1c', unit: '%', ref: '<5.7', refMin: null, refMax: 5.7, values: [null, 5.4, null, 5.2, 5.0], higher_is_worse: true },
    { name: 'Colesterol Total', unit: 'mg/dL', ref: '<190', refMin: null, refMax: 190, values: [185, 193, 180, 169, 148], higher_is_worse: true },
    { name: 'HDL', unit: 'mg/dL', ref: '>40', refMin: 40, refMax: null, values: [39, 47, 38, 38, 30], higher_is_worse: false },
    { name: 'Triglicer\u00EDdeos', unit: 'mg/dL', ref: '<150', refMin: null, refMax: 150, values: [116, 123, 92, 104, 106], higher_is_worse: true },
    { name: 'Creatinina', unit: 'mg/dL', ref: '0.7-1.3', refMin: 0.7, refMax: 1.3, values: [0.93, 1.06, 0.99, 1.06, 1.00], higher_is_worse: true },
    { name: '\u00C1cido \u00DArico', unit: 'mg/dL', ref: '3.5-7.2', refMin: 3.5, refMax: 7.2, values: [5.3, 6.1, 5.2, 5.4, 5.4], higher_is_worse: true },
    { name: 'TGO (AST)', unit: 'U/L', ref: '<40', refMin: null, refMax: 40, values: [24, 19, 27, 26, 25], higher_is_worse: true },
    { name: 'TGP (ALT)', unit: 'U/L', ref: '<41', refMin: null, refMax: 41, values: [35, 24, 35, 41, 36], higher_is_worse: true },
    { name: 'GGT', unit: 'U/L', ref: '<60', refMin: null, refMax: 60, values: [37, 32, 35, 39, 32], higher_is_worse: true },
    { name: 'TSH', unit: 'mUI/L', ref: '0.27-4.20', refMin: 0.27, refMax: 4.20, values: [1.70, 2.15, null, 2.32, 1.82], higher_is_worse: null },
    { name: 'Vitamina D', unit: 'ng/mL', ref: '30-60', refMin: 30, refMax: 60, values: [20.4, 50.2, null, 43.5, 37.6], higher_is_worse: false },
    { name: 'B12', unit: 'pg/mL', ref: '187-883', refMin: 187, refMax: 883, values: [null, 300, null, 276, 192], higher_is_worse: false },
    { name: 'Hemoglobina', unit: 'g/dL', ref: '13-17.5', refMin: 13, refMax: 17.5, values: [15.5, 15.8, 16.0, 15.8, 15.6], higher_is_worse: null },
    { name: 'Leuc\u00F3citos', unit: '/mm\u00B3', ref: '3500-10500', refMin: 3500, refMax: 10500, values: [5850, 6290, 7150, 6280, 5630], higher_is_worse: null },
    { name: 'Plaquetas', unit: '/mm\u00B3', ref: '150k-400k', refMin: 150000, refMax: 400000, values: [186000, 195000, 197000, 189000, 183000], higher_is_worse: null },
    { name: 'PSA Total', unit: 'ng/mL', ref: '<4.0', refMin: null, refMax: 4.0, values: [null, null, null, 0.46, 0.46], higher_is_worse: true },
];

// Alias map to normalize exam names across different labs
const EXAM_ALIASES = {
    'GLICOSE (EM JEJUM)': 'Glicose', 'GLICOSE': 'Glicose', 'GLICEMIA': 'Glicose', 'GLICOSE DE JEJUM': 'Glicose',
    'HEMOGLOBINA GLICOSILADA': 'HbA1c', 'HB A1C': 'HbA1c', 'HEMOGLOBINA GLICADA': 'HbA1c', 'HEMOGLOBINA GLICADA (HBA1C)': 'HbA1c',
    'COLESTEROL TOTAL': 'Colesterol Total', 'COLESTEROL TOTAL E FRAÇÕES': 'Colesterol Total',
    'HDL COLESTEROL': 'HDL', 'HDL': 'HDL', 'COLESTEROL HDL': 'HDL',
    'LDL COLESTEROL': 'LDL', 'LDL': 'LDL', 'COLESTEROL LDL': 'LDL',
    'VLDL COLESTEROL': 'VLDL', 'VLDL': 'VLDL', 'COLESTEROL VLDL': 'VLDL',
    'TRIGLICERÍDEOS': 'Triglicerídeos', 'TRIGLICERIDEOS': 'Triglicerídeos', 'TRIGLICÉRIDES': 'Triglicerídeos', 'TRIGLICERIDES': 'Triglicerídeos',
    'CREATININA': 'Creatinina',
    'ÁCIDO ÚRICO': 'Ácido Úrico', 'ACIDO URICO': 'Ácido Úrico',
    'AST - ASPARTATO AMINOTRANSFERASE (TGO)': 'TGO (AST)', 'TGO': 'TGO (AST)', 'TGO (AST)': 'TGO (AST)', 'AST (TGO)': 'TGO (AST)', 'ASPARTATO AMINOTRANSFERASE': 'TGO (AST)',
    'ALT - ALANINA AMINOTRANSFERASE (TGP)': 'TGP (ALT)', 'TGP': 'TGP (ALT)', 'TGP (ALT)': 'TGP (ALT)', 'ALT (TGP)': 'TGP (ALT)', 'ALANINA AMINOTRANSFERASE': 'TGP (ALT)',
    'GAMA GLUTAMIL TRANSFERASE (GGT)': 'GGT', 'GGT': 'GGT', 'GAMA GT': 'GGT', 'GAMA GLUTAMIL TRANSFERASE': 'GGT',
    'TSH ULTRASSENSÍVEL': 'TSH', 'TSH': 'TSH', 'TSH ULTRA SENSÍVEL': 'TSH',
    'T4 LIVRE': 'T4 Livre', 'TIROXINA LIVRE': 'T4 Livre',
    'VITAMINA D': 'Vitamina D', '25-HIDROXI VITAMINA D': 'Vitamina D', '25 OH VITAMINA D': 'Vitamina D', 'VITAMINA D - 25 HIDROXI': 'Vitamina D',
    'VITAMINA B12': 'B12', 'B12': 'B12',
    'VITAMINA A': 'Vitamina A', 'RETINOL': 'Vitamina A',
    'HEMOGLOBINA': 'Hemoglobina',
    'HEMATÓCRITO': 'Hematócrito', 'HEMATOCRITO': 'Hematócrito',
    'HEMÁCIAS': 'Hemácias', 'HEMACIAS': 'Hemácias',
    'LEUCÓCITOS': 'Leucócitos', 'LEUCOCITOS': 'Leucócitos',
    'PLAQUETAS': 'Plaquetas',
    'PSA TOTAL': 'PSA Total', 'PSA': 'PSA Total', 'ANTÍGENO PROSTÁTICO ESPECÍFICO': 'PSA Total',
    'URÉIA': 'Ureia', 'UREIA': 'Ureia',
    'FERRITINA': 'Ferritina',
    'FOSFATASE ALCALINA': 'Fosfatase Alcalina',
    'BILIRRUBINA TOTAL': 'Bilirrubina Total',
    'TESTOSTERONA TOTAL': 'Testosterona Total',
    'TESTOSTERONA LIVRE': 'Testosterona Livre',
    'LIPOPROTEÍNA (A)': 'Lipoproteína A', 'LIPOPROTEINA A': 'Lipoproteína A', 'LIPOPROTEÍNA A': 'Lipoproteína A',
    'VCM': 'VCM', 'VOL. GLOB. MÉDIO (VCM)': 'VCM',
    'HCM': 'HCM', 'HEM. GLOB. MÉDIO (HCM)': 'HCM',
    'CHCM': 'CHCM', 'C.H.GLOB. MÉDIA (CHCM)': 'CHCM',
    'RDW-CV': 'RDW-CV', 'RDW': 'RDW-CV',
    'VOLUME PLAQUETÁRIO (MPV)': 'MPV', 'MPV': 'MPV',
    'SHBG': 'SHBG',
};

function normalizeExamName(name) {
    const upper = name.toUpperCase().replace(/\s+/g, ' ').trim();
    return EXAM_ALIASES[upper] || name;
}

// Extract date from sheet name (e.g. "Hemograma 31/01/2026" -> "31/01/2026")
function extractDateFromSheet(sheetName) {
    const m = sheetName.match(/(\d{2}\/\d{2}\/\d{4})/);
    return m ? m[1] : null;
}

// Parse date string dd/mm/yyyy to comparable value
function dateToSort(dateStr) {
    const [d, m, y] = dateStr.split('/');
    return `${y}${m}${d}`;
}

// Load all CSVs and build dynamic exam history
let dynamicExamData = null;
async function loadAllExamData() {
    if (dynamicExamData) return dynamicExamData;

    const examMap = {}; // normalized name -> { dates: {dateStr: {value, unit, ref, refMin, refMax}}, ... }
    const allDates = new Set();

    const fetchPromises = SHEETS.map(async (sheet) => {
        const date = extractDateFromSheet(sheet.name);
        if (!date) return;
        allDates.add(date);

        try {
            let rows;
            if (csvCache[sheet.gid]) {
                rows = csvCache[sheet.gid];
            } else {
                const resp = await fetch(csvUrl(sheet.gid));
                if (!resp.ok) return;
                const text = await resp.text();
                rows = parseCSV(text);
                csvCache[sheet.gid] = rows;
            }

            const { exams } = parseLabReport(rows);
            exams.forEach(ex => {
                if (isNaN(ex.numValue)) return; // skip qualitative results
                const normalized = normalizeExamName(ex.name);
                if (!examMap[normalized]) {
                    examMap[normalized] = { unit: ex.unit, ref: ex.ref, refMin: ex.refMin, refMax: ex.refMax, dates: {} };
                }
                // Don't overwrite if already set for this date (first match wins)
                if (!examMap[normalized].dates[date]) {
                    examMap[normalized].dates[date] = ex.numValue;
                }
                // Update ref if we have better data
                if (ex.refMin !== null && examMap[normalized].refMin === null) examMap[normalized].refMin = ex.refMin;
                if (ex.refMax !== null && examMap[normalized].refMax === null) examMap[normalized].refMax = ex.refMax;
                if (ex.ref && !examMap[normalized].ref) examMap[normalized].ref = ex.ref;
            });
        } catch (err) {
            console.warn('Erro ao carregar sheet para evolução:', sheet.name, err);
        }
    });

    await Promise.all(fetchPromises);

    // Sort dates chronologically
    const sortedDates = [...allDates].sort((a, b) => dateToSort(a).localeCompare(dateToSort(b)));

    // Filter exams with 2+ data points
    const chartsData = [];
    for (const [name, data] of Object.entries(examMap)) {
        const dateEntries = Object.keys(data.dates);
        if (dateEntries.length >= 2) {
            const values = sortedDates.map(d => data.dates[d] !== undefined ? data.dates[d] : null);
            chartsData.push({
                name,
                unit: data.unit,
                ref: data.ref,
                refMin: data.refMin,
                refMax: data.refMax,
                values,
            });
        }
    }

    // Sort charts: prioritize key exams first, then alphabetical
    const priorityOrder = ['Glicose', 'HbA1c', 'Colesterol Total', 'HDL', 'LDL', 'VLDL', 'Triglicerídeos',
        'Creatinina', 'Ácido Úrico', 'Ureia', 'TGO (AST)', 'TGP (ALT)', 'GGT', 'Fosfatase Alcalina',
        'Bilirrubina Total', 'TSH', 'T4 Livre', 'Testosterona Total', 'Testosterona Livre',
        'PSA Total', 'Vitamina D', 'B12', 'Vitamina A', 'Ferritina',
        'Hemoglobina', 'Hematócrito', 'Hemácias', 'Leucócitos', 'Plaquetas', 'VCM', 'HCM', 'CHCM', 'RDW-CV', 'MPV'];
    chartsData.sort((a, b) => {
        const ia = priorityOrder.indexOf(a.name);
        const ib = priorityOrder.indexOf(b.name);
        if (ia !== -1 && ib !== -1) return ia - ib;
        if (ia !== -1) return -1;
        if (ib !== -1) return 1;
        return a.name.localeCompare(b.name);
    });

    dynamicExamData = { dates: sortedDates, charts: chartsData };
    return dynamicExamData;
}

const CHART_COLORS = ['#667eea', '#f7971e', '#38ef7d', '#ff758c', '#764ba2', '#00b4d8'];
let chartInstances = [];

// ===== CSV URL =====
function csvUrl(gid) {
    return `https://docs.google.com/spreadsheets/d/e/${SPREADSHEET_PUB_ID}/pub?output=csv&gid=${gid}`;
}

// ===== CSV PARSER =====
function parseCSV(text) {
    const rows = [];
    let current = '';
    let inQuotes = false;
    let row = [];
    for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (inQuotes) {
            if (ch === '"' && text[i + 1] === '"') { current += '"'; i++; }
            else if (ch === '"') { inQuotes = false; }
            else { current += ch; }
        } else {
            if (ch === '"') { inQuotes = true; }
            else if (ch === ',') { row.push(current.trim()); current = ''; }
            else if (ch === '\n' || (ch === '\r' && text[i + 1] === '\n')) {
                row.push(current.trim()); current = '';
                if (ch === '\r') i++;
                if (row.some(cell => cell !== '')) rows.push(row);
                row = [];
            } else { current += ch; }
        }
    }
    if (current || row.length > 0) {
        row.push(current.trim());
        if (row.some(cell => cell !== '')) rows.push(row);
    }
    return rows;
}

// ===== LAB REPORT PARSER =====
function parseBR(s) {
    if (!s) return NaN;
    s = s.toString().trim();
    if (s.includes(',') && s.includes('.')) {
        return parseFloat(s.replace(/\./g, '').replace(',', '.'));
    } else if (s.includes(',')) {
        return parseFloat(s.replace(',', '.'));
    } else if (/\.\d{3}($|\D)/.test(s)) {
        return parseFloat(s.replace(/\./g, ''));
    }
    return parseFloat(s);
}

function getStatus(numVal, refMin, refMax) {
    if (isNaN(numVal)) return 'info';
    if (refMin !== null && !isNaN(refMin) && numVal < refMin) return 'warning';
    if (refMax !== null && !isNaN(refMax) && numVal > refMax) return 'warning';
    return 'normal';
}

function cleanExamName(name) {
    return name.replace(/\.+/g, '').replace(/\s+/g, ' ').trim();
}

function parseLabReport(rows) {
    const fullText = rows.flat().join('\n');
    const exams = [];
    const seen = new Set();

    function addExam(name, value, unit, ref, refMin, refMax) {
        name = cleanExamName(name);
        if (!name || name.length < 2) return;
        // Skip non-exam entries
        const skip = /^(LABORATÓRIO|Paciente|Data|Médico|CPF|Prescrição|Coleta|Page|Participamos|www\.|CEP|Rua|Avenida|CNPJ|CRF|CNES|RT:|Aprovado|Impressão|Pedido|Resultado anterior|Método|Material|Convênio|Identidade|Idade|Nome\/Name|Solicitante|Fone|Tel|RG|NOTA|Cliente|Licen)/i;
        if (skip.test(name)) return;
        const key = name.toUpperCase().replace(/\s+/g, '');
        if (seen.has(key)) return;
        seen.add(key);
        const numValue = parseBR(value);
        const status = getStatus(numValue, refMin, refMax);
        exams.push({ name, value: value.toString(), numValue, unit: unit || '', ref: ref || '', refMin, refMax, status });
    }

    // Extract lab info
    const labInfo = {};
    const dateMatch = fullText.match(/(?:Data (?:Atend|Coleta|Entrada)[.\s:]*|Service date:\s*)([\d]{2}\/[\d]{2}\/[\d]{4})/i);
    if (dateMatch) labInfo.date = dateMatch[1];
    const doctorMatch = fullText.match(/(?:Solicitante\/Doctor|Médico\(a\)|Solicitante)[:\s]+([A-ZÁÉÍÓÚÃÕÇ][A-Za-záéíóúãõçÁÉÍÓÚÃÕÇ\s]+?)(?:\n|RG|Prescrição|$)/);
    if (doctorMatch) labInfo.doctor = doctorMatch[1].trim();
    if (/hemolabRN/i.test(fullText)) labInfo.lab = 'Hemolab RN';
    else if (/UNIMED NATAL/i.test(fullText)) labInfo.lab = 'Laboratório Unimed Natal';

    // === PASS 1: Hemolab dots pattern ===
    // NAME.{2,}:  VALUE UNIT
    const dotsRe = /([A-ZÁÉÍÓÚÃÕÇ][A-ZÁÉÍÓÚÃÕÇ\s\(\)\-\/,\.]+?)\.{2,}:\s{0,10}([\d]+[.,]?\d*)\s+([\w\/³²%µ\.]+)/g;
    let m;
    while ((m = dotsRe.exec(fullText)) !== null) {
        const name = m[1];
        const value = m[2];
        const unit = m[3];
        // Find reference in next ~500 chars
        const after = fullText.substring(m.index, m.index + 600);
        let ref = '', refMin = null, refMax = null;
        // "X a Y" pattern
        const rangeM = after.match(/(?:normal|refer[eê]ncia|Adulto)[^\n]*?([\d][.,\d]*)\s+[aà]\s+([\d][.,\d]*)/i);
        if (rangeM) { refMin = parseBR(rangeM[1]); refMax = parseBR(rangeM[2]); ref = `${rangeM[1]} a ${rangeM[2]}`; }
        // "Inferior a X" / "Menor que X" / "< X"
        if (refMax === null) {
            const ltM = after.match(/(?:Inferior\s+a|Menor\s+que|<\s*(?:que\s*)?)\s*([\d][.,\d]*)/i);
            if (ltM) { refMax = parseBR(ltM[1]); ref = `< ${ltM[1]}`; }
        }
        // "Superior a X" / "> X"
        if (refMin === null && refMax === null) {
            const gtM = after.match(/(?:Superior\s+a|>\s*)\s*([\d][.,\d]*)/i);
            if (gtM) { refMin = parseBR(gtM[1]); ref = `> ${gtM[1]}`; }
        }
        addExam(name, value, unit, ref, refMin, refMax);
    }

    // === PASS 2: "Resultado:" + value pattern (Unimed) ===
    // Handles: "Resultado:  VALUE UNIT", "Resultado:\nVALUE UNIT", "Resultado:VALUE\nUNIT"
    const resRe = /Resultado:\s*([\d]+[.,]?\d*)\s*([\w\/³²%µ\.]*)/g;
    while ((m = resRe.exec(fullText)) !== null) {
        const value = m[1];
        let unit = m[2];
        // If unit is empty, check next line
        if (!unit) {
            const nextLine = fullText.substring(m.index + m[0].length, m.index + m[0].length + 50);
            const unitM = nextLine.match(/^\s*([\w\/³²%µ\.]+)/);
            if (unitM) unit = unitM[1];
        }
        // Look backwards for exam name 
        const before = fullText.substring(Math.max(0, m.index - 400), m.index);
        const lines = before.split('\n').filter(l => l.trim());
        let name = '';
        for (let i = lines.length - 1; i >= 0; i--) {
            const line = lines[i].trim();
            if (/^(Material|Método|Resultado|\d|Aprovado|Data|Horário|CRF|POSTO|RG|CPF|Prescrição|Coleta|www\.|Participamos|A interpretação|CEP|Rua|Avenida|LABORATÓRIO|Paciente|Médico|0$)/i.test(line)) continue;
            if (/^[A-ZÁÉÍÓÚÃÕÇ]/.test(line) && line.length > 2 && line.length < 80) {
                name = line.replace(/\s+Material:.*/, '').trim();
                break;
            }
        }
        if (!name) continue;
        // Find reference
        const after = fullText.substring(m.index, m.index + 800);
        let ref = '', refMin = null, refMax = null;
        // Adult male range patterns
        const adultM = after.match(/(?:Masculino|Adulto|Normal|Homens \(20 a 49)[^\n]*?([\d][.,\d]*)\s+[aà]\s+([\d][.,\d]*)/i);
        if (adultM) { refMin = parseBR(adultM[1]); refMax = parseBR(adultM[2]); ref = `${adultM[1]} a ${adultM[2]}`; }
        if (refMin === null && refMax === null) {
            const genRange = after.match(/(?:refer[eê]ncia|Normal)[^\n]*?([\d][.,\d]*)\s+[aà]\s+([\d][.,\d]*)/i);
            if (genRange) { refMin = parseBR(genRange[1]); refMax = parseBR(genRange[2]); ref = `${genRange[1]} a ${genRange[2]}`; }
        }
        if (refMax === null) {
            const ltM = after.match(/(?:Inferior|Menor|<\s*(?:que)?|Até|Desej[aá]vel[:\s]*<\s*(?:que\s*)?)\s*([\d][.,\d]*)/i);
            if (ltM) { refMax = parseBR(ltM[1]); ref = `< ${ltM[1]}`; }
        }
        if (refMin === null && refMax === null) {
            const gtM = after.match(/(?:Superior\s+a|>\s*)\s*([\d][.,\d]*)/i);
            if (gtM) { refMin = parseBR(gtM[1]); ref = `> ${gtM[1]}`; }
        }
        addExam(name, value, unit, ref, refMin, refMax);
    }

    // === PASS 3: Sub-result patterns ===
    // Bilirrubina Total...: 0,98 mg/dL   0,2 a 1,3
    // PSA Total:   0,46 ng/mL
    // Hb A1c...: 5,0 %
    // SHBG...: 16,70 nmol/L
    // Testosterona Livre: 8,951 ng/dL
    const subRe = /((?:Bilirrubina\s+\w+|PSA\s+\w+|Hb\s*A1c|SHBG|Testosterona\s+Livre|Glicemia\s+[Mm]\u00E9dia|Rela[çc][aã]o))[.:\s]+([\d]+[.,]?\d*)\s*([\w\/³²%µ\.]+)/g;
    while ((m = subRe.exec(fullText)) !== null) {
        const name = m[1].trim();
        const value = m[2];
        const unit = m[3];
        const after = fullText.substring(m.index, m.index + 400);
        let ref = '', refMin = null, refMax = null;
        const rangeM = after.match(/([\d][.,\d]*)\s+[aà]\s+([\d][.,\d]*)\s*[\w\/³²%µ\.]*\s*$/m);
        if (rangeM) { refMin = parseBR(rangeM[1]); refMax = parseBR(rangeM[2]); ref = `${rangeM[1]} a ${rangeM[2]}`; }
        addExam(name, value, unit, ref, refMin, refMax);
    }

    // === PASS 4: Hemograma inline patterns ===
    const hemoNames = [
        { re: /Hem[aá]cias[:\s.]+\s*([\d][.,\d]*)\s*([\w\/³²%µ\.]+)\s+([\d][.,\d]*)\s+[aà]\s+([\d][.,\d]*)/, name: 'Hemácias' },
        { re: /Hemoglobina[:\s.]+\s*([\d][.,\d]*)\s*([\w\/³²%µ\.]+)\s+([\d][.,\d]*)\s+[aà]\s+([\d][.,\d]*)/, name: 'Hemoglobina' },
        { re: /Hemat[oó]crito[:\s.]+\s*([\d][.,\d]*)\s*([\w\/³²%µ\.]+)\s+([\d][.,\d]*)\s+[aà]\s+([\d][.,\d]*)/, name: 'Hematócrito' },
        { re: /Vol\.\s*Glob\.\s*M[eé]dio\s*\(VCM\)[:\s.]+\s*([\d][.,\d]*)\s*([\w\/³²%µ\.]+)\s+([\d][.,\d]*)\s+[aà]\s+([\d][.,\d]*)/, name: 'VCM' },
        { re: /Hem\.\s*Glob\.\s*M[eé]dio\s*\(HCM\)[:\s.]+\s*([\d][.,\d]*)\s*([\w\/³²%µ\.]+)\s+([\d][.,\d]*)\s+[aà]\s+([\d][.,\d]*)/, name: 'HCM' },
        { re: /C\.H\.Glob\.\s*M[eé]dia\s*\(CHCM\)[:\s.]+\s*([\d][.,\d]*)\s*([\w\/³²%µ\.]+)\s+([\d][.,\d]*)\s+[aà]\s+([\d][.,\d]*)/, name: 'CHCM' },
        { re: /RDW[\s-]*CV\s*%?[:\s.]+\s*([\d][.,\d]*)\s*([\w\/³²%µ\.]+)\s+([\d][.,\d]*)\s+[aà]\s+([\d][.,\d]*)/, name: 'RDW-CV' },
    ];
    for (const h of hemoNames) {
        const hm = fullText.match(h.re);
        if (hm) addExam(h.name, hm[1], hm[2], `${hm[3]} a ${hm[4]}`, parseBR(hm[3]), parseBR(hm[4]));
    }
    // Leucócitos
    const leucM = fullText.match(/Leuc[oó]citos[:\s.]+\s*([\d][.,\d]*)\s*([\w\/³²%µ\.]+)\s+([\d][.,\d]*)\s+[aà]\s+([\d][.,\d]*)/);
    if (leucM) addExam('Leucócitos', leucM[1], leucM[2], `${leucM[3]} a ${leucM[4]}`, parseBR(leucM[3]), parseBR(leucM[4]));
    // Plaquetas
    const plaqM = fullText.match(/Plaquetas[:\s.]+\s*([\d][.,\d]*)\s*([\w\/³²%µ\.]+)\s+([\d][.,\d]*)\s+[aà]\s+([\d][.,\d]*)/);
    if (plaqM) addExam('Plaquetas', plaqM[1], plaqM[2], `${plaqM[3]} a ${plaqM[4]}`, parseBR(plaqM[3]), parseBR(plaqM[4]));
    // Volume plaquetário
    const mpvM = fullText.match(/Volume\s+Plaquet[aá]rio\s*\(MPV\)[:\s.]+\s*([\d][.,\d]*)/);
    if (mpvM) addExam('Volume Plaquetário (MPV)', mpvM[1], '', '9 a 12', 9, 12);

    // === PASS 5: Single-line format (Colesterol) ===
    const singleRe = /([A-ZÁÉÍÓÚÃÕÇ][A-ZÁÉÍÓÚÃÕÇ\s]+?)\s+Material:[\s\S]*?Resultado:\s*([\d]+[.,]?\d*)\s*([\w\/³²%µ\.]*)/g;
    while ((m = singleRe.exec(fullText)) !== null) {
        const name = m[1].trim();
        const value = m[2];
        const unit = m[3];
        const after = fullText.substring(m.index, m.index + 500);
        let ref = '', refMin = null, refMax = null;
        const ltM = after.match(/(?:Desej[aá]vel|Inferior)[:\s]*<?\s*(?:que\s*)?([\d][.,\d]*)/i);
        if (ltM) { refMax = parseBR(ltM[1]); ref = `< ${ltM[1]}`; }
        addExam(name, value, unit, ref, refMin, refMax);
    }

    // === PASS 6: Qualitative results ===
    const qualRe = /Resultado:\s*(N[aã]o Detect[aá]vel|Detect[aá]vel|Reagente|N[aã]o Reagente|Positivo|Negativo)/gi;
    while ((m = qualRe.exec(fullText)) !== null) {
        const resultVal = m[1];
        const before = fullText.substring(Math.max(0, m.index - 400), m.index);
        const lines = before.split('\n').filter(l => l.trim());
        let name = '';
        for (let i = lines.length - 1; i >= 0; i--) {
            const line = lines[i].trim();
            if (/^(Material|Método|Resultado|\d|Aprovado|Data|Horário|CRF|POSTO|RG|CPF|Prescrição|Coleta|www\.|Participamos|A interpretação|CEP|Rua|Avenida|LABORATÓRIO|Paciente|Médico|0$)/i.test(line)) continue;
            if (/^[A-ZÁÉÍÓÚÃÕÇ]/.test(line) && line.length > 3 && line.length < 100) {
                name = line.trim();
                break;
            }
        }
        if (name) addExam(name, resultVal, '', resultVal, null, null);
    }

    return { labInfo, exams };
}

// ===== RENDER LAB REPORT (CSV TABS) =====
function renderLabReport(rows, sheetName) {
    const content = document.getElementById('tabContent');
    const { labInfo, exams } = parseLabReport(rows);

    if (exams.length === 0) {
        // Fallback to raw table
        renderTable(rows, sheetName);
        return;
    }

    let html = '<div class="tab-content">';

    // Lab header
    html += '<div class="lab-header">';
    html += `<div class="lab-header-title">${escapeHTML(sheetName)}</div>`;
    html += '<div class="lab-header-meta">';
    if (labInfo.lab) html += `<span>\uD83C\uDFE5 ${escapeHTML(labInfo.lab)}</span>`;
    if (labInfo.date) html += `<span>\uD83D\uDCC5 ${escapeHTML(labInfo.date)}</span>`;
    if (labInfo.doctor) html += `<span>\uD83D\uDC68\u200D\u2695\uFE0F ${escapeHTML(labInfo.doctor)}</span>`;
    html += '</div></div>';

    // Exam cards
    html += '<div class="cards-grid">';
    exams.forEach(ex => {
        const badgeClass = ex.status === 'normal' ? 'badge-normal' : ex.status === 'warning' ? 'badge-warning' : ex.status === 'danger' ? 'badge-danger' : 'badge-info';
        const badgeText = ex.status === 'normal' ? 'Normal' : ex.status === 'warning' ? 'Alerta' : ex.status === 'danger' ? 'Cr\u00EDtico' : 'Info';
        // Format display value
        let displayVal = ex.value.replace(',', '.');
        const numDisplay = parseFloat(displayVal);
        if (!isNaN(numDisplay)) {
            // Show thousands formatting for large numbers
            if (numDisplay >= 1000) displayVal = numDisplay.toLocaleString('pt-BR');
            else displayVal = ex.value;
        } else {
            displayVal = ex.value;
        }
        html += `<div class="exam-card status-${ex.status}">
            <div class="card-header">
                <span class="card-name">${escapeHTML(ex.name)}</span>
                <span class="card-badge ${badgeClass}">${badgeText}</span>
            </div>
            <div class="card-value">${escapeHTML(displayVal)}<span class="card-unit">${escapeHTML(ex.unit)}</span></div>
            ${ex.ref ? `<div class="card-ref">Ref: ${escapeHTML(ex.ref)}</div>` : ''}
        </div>`;
    });
    html += '</div>';

    // Raw text toggle
    const rawText = rows.flat().join('\n');
    html += `<div class="lab-raw-section">
        <button class="lab-raw-toggle" onclick="this.nextElementSibling.classList.toggle('show')">
            \uD83D\uDCC4 Ver laudo completo \u25BC
        </button>
        <div class="lab-raw-content">
            <pre>${escapeHTML(rawText)}</pre>
        </div>
    </div>`;

    html += '</div>';
    content.innerHTML = html;
}

// ===== RENDER TABS =====
function renderTabs() {
    const nav = document.getElementById('tabsNav');
    let html = '';
    html += `<button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>`;
    html += `<button class="tab-btn" onclick="switchTab('evolucao')">Evolu\u00E7\u00E3o</button>`;
    html += `<div class="tab-separator"></div>`;
    SHEETS.forEach((sheet, i) => {
        html += `<button class="tab-btn" data-sheet="${i}" onclick="switchTab(${i})">${sheet.name}</button>`;
    });
    nav.innerHTML = html;
}

// ===== SWITCH TAB =====
async function switchTab(tab) {
    chartInstances.forEach(c => c.destroy());
    chartInstances = [];

    document.querySelectorAll('.tab-btn').forEach(btn => {
        let isActive = false;
        if (tab === 'dashboard' && btn.textContent === 'Dashboard') isActive = true;
        else if (tab === 'evolucao' && btn.textContent === 'Evolu\u00E7\u00E3o') isActive = true;
        else if (typeof tab === 'number' && btn.dataset.sheet == tab) isActive = true;
        btn.classList.toggle('active', isActive);
    });

    activeTab = tab;
    const content = document.getElementById('tabContent');

    if (tab === 'dashboard') { renderDashboard(); return; }
    if (tab === 'evolucao') { await renderEvolucao(); return; }

    const index = tab;
    const sheet = SHEETS[index];

    if (csvCache[sheet.gid]) {
        renderLabReport(csvCache[sheet.gid], sheet.name);
        return;
    }

    content.innerHTML = `
        <div class="table-card">
            <div class="loading-container">
                <div class="spinner"></div>
                <div class="loading-text">Carregando ${sheet.name}...</div>
            </div>
        </div>`;

    try {
        const resp = await fetch(csvUrl(sheet.gid));
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const text = await resp.text();
        const rows = parseCSV(text);
        csvCache[sheet.gid] = rows;
        if (activeTab === index) {
            renderLabReport(rows, sheet.name);
        }
        showDataSource(true);
    } catch (err) {
        console.warn('Erro ao carregar:', err);
        if (activeTab === index) {
            content.innerHTML = `
                <div class="table-card">
                    <div class="error-container">
                        <div class="error-icon">&#9888;</div>
                        <p>Nao foi possivel carregar os dados de <strong>${sheet.name}</strong>.</p>
                        <p style="font-size:0.85em;margin-top:8px;">${err.message}</p>
                        <button onclick="switchTab(${index})">Tentar novamente</button>
                    </div>
                </div>`;
        }
        showDataSource(false);
    }
}

// ===== RENDER DASHBOARD =====
function renderDashboard() {
    const content = document.getElementById('tabContent');
    let html = '<div class="tab-content">';

    html += '<div class="alerts-section"><h3>Alertas \u2014 Exames fora da faixa</h3>';
    DASHBOARD_DATA.alerts.forEach(a => {
        html += `<div class="alert-item alert-${a.type}">
            <span class="alert-icon">${a.icon}</span>
            <span class="alert-name">${a.name}:</span>
            <span>${a.value}</span>
            <span class="alert-detail">(${a.ref}) \u2014 ${a.detail}</span>
        </div>`;
    });
    html += '</div>';

    DASHBOARD_DATA.categories.forEach(cat => {
        html += `<div class="category-section">
            <div class="category-title">${cat.title}</div>
            <div class="cards-grid">`;
        cat.exams.forEach(ex => {
            const badgeClass = ex.status === 'normal' ? 'badge-normal' : ex.status === 'warning' ? 'badge-warning' : 'badge-danger';
            const badgeText = ex.status === 'normal' ? 'Normal' : ex.status === 'warning' ? 'Alerta' : 'Cr\u00EDtico';
            const displayValue = ex.name === 'Plaquetas' ? (ex.value / 1000).toFixed(0) + '.000' : ex.value;
            html += `<div class="exam-card status-${ex.status}">
                <div class="card-header">
                    <span class="card-name">${ex.name}</span>
                    <span class="card-badge ${badgeClass}">${badgeText}</span>
                </div>
                <div class="card-value">${displayValue}<span class="card-unit">${ex.unit}</span></div>
                <div class="card-ref">Ref: ${ex.ref}</div>
            </div>`;
        });
        html += '</div></div>';
    });

    html += '</div>';
    content.innerHTML = html;
}

// ===== RENDER EVOLUÇÃO =====
async function renderEvolucao() {
    const content = document.getElementById('tabContent');

    // Show loading while fetching all CSVs
    content.innerHTML = `
        <div class="tab-content">
            <div class="table-card">
                <div class="loading-container">
                    <div class="spinner"></div>
                    <div class="loading-text">Carregando dados de todos os exames...</div>
                </div>
            </div>
        </div>`;

    const data = await loadAllExamData();

    let html = '<div class="tab-content">';

    // Comparative table (still uses hardcoded EVO_EXAMS for curated view)
    html += '<div class="evolution-section"><h3>Tabela Comparativa</h3>';
    html += '<div class="evo-table-wrap"><table class="evo-table"><thead><tr>';
    html += '<th>Exame</th>';
    EVO_DATES.forEach(d => { html += `<th>${d}</th>`; });
    html += '</tr></thead><tbody>';

    EVO_EXAMS.forEach(exam => {
        html += '<tr>';
        html += `<td>${exam.name} <span style="color:#a0aec0;font-weight:400;font-size:0.85em">(${exam.unit})</span></td>`;
        exam.values.forEach((val, i) => {
            if (val === null) {
                html += '<td style="color:#cbd5e0">\u2014</td>';
            } else {
                let arrow = '';
                let cls = '';
                if (i > 0) {
                    let prev = null;
                    for (let j = i - 1; j >= 0; j--) {
                        if (exam.values[j] !== null) { prev = exam.values[j]; break; }
                    }
                    if (prev !== null && val !== prev) {
                        const went_up = val > prev;
                        if (exam.higher_is_worse === true) {
                            cls = went_up ? 'val-up' : 'val-down';
                            arrow = went_up ? ' <span class="arrow">\u2191</span>' : ' <span class="arrow">\u2193</span>';
                        } else if (exam.higher_is_worse === false) {
                            cls = went_up ? 'val-down' : 'val-up';
                            arrow = went_up ? ' <span class="arrow">\u2191</span>' : ' <span class="arrow">\u2193</span>';
                        } else {
                            cls = 'val-same';
                            arrow = went_up ? ' <span class="arrow">\u2191</span>' : ' <span class="arrow">\u2193</span>';
                        }
                    }
                }
                const displayVal = exam.name === 'Plaquetas' || exam.name === 'Leuc\u00F3citos'
                    ? val.toLocaleString('pt-BR')
                    : val;
                html += `<td class="${cls}">${displayVal}${arrow}</td>`;
            }
        });
        html += '</tr>';
    });

    html += '</tbody></table></div></div>';

    // Dynamic charts section
    html += `<div class="evolution-section"><h3>Gr\u00E1ficos de Evolu\u00E7\u00E3o</h3>`;
    html += `<p style="color:#718096;font-size:0.9em;margin-bottom:15px;">${data.charts.length} exames com hist\u00F3rico em ${data.dates.length} datas</p>`;
    html += '<div class="charts-grid">';
    data.charts.forEach((exam, i) => {
        const unitLabel = exam.unit ? ` (${exam.unit})` : '';
        html += `<div class="chart-card"><h4>${exam.name}${unitLabel}</h4><canvas id="chart-${i}"></canvas></div>`;
    });
    html += '</div></div>';

    html += '</div>';
    content.innerHTML = html;

    requestAnimationFrame(() => renderDynamicCharts(data));
}

function renderDynamicCharts(data) {
    data.charts.forEach((exam, i) => {
        const canvas = document.getElementById(`chart-${i}`);
        if (!canvas) return;

        const refBandPlugin = {
            id: 'refBand',
            beforeDraw(chart) {
                if (exam.refMin === null && exam.refMax === null) return;
                const { ctx, chartArea: { top, bottom, left, right }, scales: { y } } = chart;
                ctx.save();
                ctx.fillStyle = 'rgba(0,0,0,0.04)';
                const yTop = exam.refMax !== null ? y.getPixelForValue(exam.refMax) : top;
                const yBottom = exam.refMin !== null ? y.getPixelForValue(exam.refMin) : bottom;
                ctx.fillRect(left, Math.min(yTop, yBottom), right - left, Math.abs(yBottom - yTop));
                ctx.restore();
            }
        };

        const chart = new Chart(canvas, {
            type: 'line',
            data: {
                labels: data.dates,
                datasets: [{
                    label: exam.name,
                    data: exam.values.map(v => v === null ? undefined : v),
                    borderColor: CHART_COLORS[0],
                    backgroundColor: CHART_COLORS[0] + '20',
                    borderWidth: 2.5, pointRadius: 4, pointHoverRadius: 6, tension: 0.3, spanGaps: true,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: true,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: { backgroundColor: 'white', titleColor: '#2d3748', bodyColor: '#4a5568', borderColor: '#e2e8f0', borderWidth: 1, padding: 10, cornerRadius: 8 }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: { beginAtZero: false, grid: { color: '#f0f0f0' } }
                }
            },
            plugins: [refBandPlugin]
        });
        chartInstances.push(chart);
    });
}

// ===== RENDER TABLE (fallback) =====
function renderTable(rows, sheetName) {
    const content = document.getElementById('tabContent');
    if (!rows || rows.length === 0) {
        content.innerHTML = `<div class="table-card"><div class="empty-state">Nenhum dado encontrado em "${sheetName}".</div></div>`;
        return;
    }
    const headers = rows[0];
    const dataRows = rows.slice(1);
    let html = '<div class="table-card"><table class="data-table"><thead><tr>';
    headers.forEach(h => { html += `<th>${escapeHTML(h)}</th>`; });
    html += '</tr></thead><tbody>';
    dataRows.forEach(row => {
        html += '<tr>';
        for (let i = 0; i < headers.length; i++) { html += `<td>${escapeHTML(row[i] || '')}</td>`; }
        html += '</tr>';
    });
    html += '</tbody></table></div>';
    content.innerHTML = html;
}

// ===== HELPERS =====
function escapeHTML(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function showDataSource(online) {
    const el = document.getElementById('dataSource');
    el.style.display = 'flex';
    const timeStr = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    if (online) {
        el.innerHTML = `<span class="source-dot source-online"></span> Dados carregados do Google Sheets <span class="source-time">as ${timeStr}</span> <button class="btn-refresh" onclick="location.reload()">&#8635; Atualizar</button>`;
        el.className = 'data-source data-source-online';
    } else {
        el.innerHTML = `<span class="source-dot source-offline"></span> Erro ao carregar dados <button class="btn-refresh" onclick="location.reload()">&#8635; Tentar novamente</button>`;
        el.className = 'data-source data-source-offline';
    }
}

// ===== INIT =====
(async function init() {
    await discoverSheets();
    renderTabs();
    switchTab('dashboard');
})();
</script>

</body>
</html>
